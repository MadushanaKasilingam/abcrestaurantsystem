<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/css2?family=Lobster&display=swap" rel="stylesheet">
    <title>Food Management</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@100;200;300;400;500;600&display=swap');

        :root {
            --green: #27ae60;
            --black: #333;
            --white: #fff;
            --bg-color: #eee;
            --box-shadow: 0 .5rem 1rem rgba(0, 0, 0, .1);
            --border: .1rem solid var(--black);
        }

        * {
            font-family: 'Poppins', sans-serif;
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            outline: none;
            border: none;
            text-decoration: none;
            text-transform: capitalize;
        }

        html {
            font-size: 62.5%;
            overflow-x: hidden;
        }

        body {
            background-color: var(--bg-color);
        }

        .container {
            max-width: 1200px;
            padding: 2rem;
            margin: 2rem auto;
            background-color: var(--white);
            box-shadow: var(--box-shadow);
            border-radius: .5rem;
        }

        h1 {
            text-align: center;
            color: #3b141c;
            font-family: "Lobster", sans-serif;
            font-size: 45px;
            margin-bottom: 2rem;
        }

        .btn {
            background-color: #f3961c;
            color: white;
            display: block;
            border-radius: .5rem;
            margin-top: 1rem;
            font-size: 17px;
            padding: 1rem 3rem;
            font-family: 'Poppins', sans-serif;
            width: 100%;
            border: none;
            cursor: pointer;
        }

        .message {
            display: block;
            background: var(--bg-color);
            padding: 1.5rem 1rem;
            font-size: 2rem;
            color: var(--black);
            margin-bottom: 2rem;
            text-align: center;
        }

        .food-list {
            margin-top: 2rem;
        }

        .restaurant-section {
            margin-bottom: 2rem;
        }

        .restaurant-section h2 {
            font-size: 2rem;
            color: var(--black);
            margin-bottom: 1rem;
        }

        .category-section {
            margin-bottom: 1.5rem;
        }

        .category-section h3 {
            font-size: 1.8rem;
            color: var(--black);
            margin-bottom: 0.5rem;
        }

        .food-item {
            display: flex;
            justify-content: space-between;
            background-color: var(--bg-color);
            padding: 1.5rem;
            margin-bottom: 1rem;
            border-radius: .5rem;
            box-shadow: var(--box-shadow);
        }

        .food-item h4 {
            margin: 0;
            font-size: 1.6rem;
            color: var(--black);
        }

        .food-actions {
            display: flex;
            gap: 1rem;
        }

        .food-actions .btn {
            background-color: #f0ad4e;
        }
        .food-actions .btn:hover {
            background-color: #f3961c;
        }

        .food-actions .btn-delete {
            background-color: #d9534f;
        }

        .food-actions .btn-delete:hover {
            background-color: #c9302c;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: var(--white);
            padding: 2rem;
            border-radius: .5rem;
            width: 40rem;
        }

        .modal-content input,
        .modal-content textarea,
        .modal-content select {
            width: 100%;
            padding: 1rem;
            margin-bottom: 1rem;
            border: 1px solid #ccc;
            border-radius: .5rem;
            font-size: 1.7rem;
        }

        .success-message {
            color: #3b141c;
            font-size: 16px;
            margin-top: 2rem;
            text-align: center;
        }

        .error-message {
            color: #3b141c;
            font-size: 16px;
            margin-top: 2rem;
            text-align: center;
        }
        .navbar {
            background-color: #3b141c;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: var(--white);
        }

        .navbar .nav-left, .navbar .nav-right {
            display: flex;
            font-size: 18px;
            gap: 2rem;
            color: white;
        }

        .navbar a {
            color: white;
            font-size: 18px;
            text-decoration: none;
            cursor: pointer;
        }

        .navbar a:hover {
            text-decoration: underline;
        }

        @media (max-width: 991px) {
            html {
                font-size: 55%;
            }
        }

        @media (max-width: 768px) {
            .food-list {
                overflow-y: scroll;
            }
        }

        @media (max-width: 450px) {
            html {
                font-size: 50%;
            }
        }
    </style>
</head>
<body>
    <div class="navbar">
        <div class="nav-left">
            <span>Admin Panel</span>
        </div>
        <div class="nav-right">
            <a href="adminpanel.html">Home</a>
            <a id="logoutBtn" href="login.html">Logout</a>
        </div>
        
    </div>

    <div class="container">
        <h1>Food Management</h1>
        <button class="btn" id="addFoodBtn">Add Food</button>
        <div id="message"></div>
        <div class="food-list" id="foodList">
            <!-- Food items will be loaded here dynamically -->
        </div>
    </div>

    <!-- Modal for Adding/Updating Food -->
    <div class="modal" id="foodModal">
        <div class="modal-content">
            <h2 id="modalTitle">Add Food</h2>
            <label for="restaurantSelect">Select Restaurant</label>
            <select id="restaurantSelect">
                <!-- Restaurant options will be loaded here dynamically -->
            </select>
            <label for="categorySelect">Select Category</label>
            <select id="categorySelect">
                <!-- Category options will be loaded here dynamically -->
            </select>
            <input type="text" id="foodName" placeholder="Food Name" required>
            <textarea id="foodDescription" placeholder="Description" required></textarea>
            <input type="number" id="foodPrice" placeholder="Price" required>
            <input type="text" id="foodImages" placeholder="Image URLs (comma separated)" required>
            <label>
                <input type="checkbox" id="foodAvailable"> Available
            </label>
            <label>
                <input type="checkbox" id="isVegetarian"> Vegetarian
            </label>
            <label>
                <input type="checkbox" id="isSeasonal"> Seasonal
            </label>
            <input type="datetime-local" id="createdDate" required>
            <button class="btn" id="saveFoodBtn">Save</button>
        </div>
    </div>

    <script>
        const foodList = document.getElementById('foodList');
        const foodModal = document.getElementById('foodModal');
        const modalTitle = document.getElementById('modalTitle');
        const saveFoodBtn = document.getElementById('saveFoodBtn');
        const addFoodBtn = document.getElementById('addFoodBtn');
        const messageDiv = document.getElementById('message');
        const token = localStorage.getItem('jwt');
        
        const restaurantSelect = document.getElementById('restaurantSelect');
        const categorySelect = document.getElementById('categorySelect');
        const foodName = document.getElementById('foodName');
        const foodPrice = document.getElementById('foodPrice');
        const foodDescription = document.getElementById('foodDescription');
        const foodImages = document.getElementById('foodImages');
        const foodAvailable = document.getElementById('foodAvailable');
        const isVegetarian = document.getElementById('isVegetarian');
        const isSeasonal = document.getElementById('isSeasonal');
        const createdDate = document.getElementById('createdDate');
        
        let isUpdate = false;
        let currentFoodId = null;
        
        // Fetch and display all food items grouped by restaurant and category
        async function loadFoods() {
            try {
                const response = await fetch('http://localhost:5786/api/food', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
        
                const data = await response.json();
        
                foodList.innerHTML = '';
        
                if (Array.isArray(data) && data.length > 0) {
                    const restaurants = {};
        
                    // Group foods by restaurant and category
                    data.forEach(food => {
                        if (!restaurants[food.restaurant.id]) {
                            restaurants[food.restaurant.id] = {
                                name: food.restaurant.name,
                                categories: {}
                            };
                        }
        
                        if (!restaurants[food.restaurant.id].categories[food.foodCategory.id]) {
                            restaurants[food.restaurant.id].categories[food.foodCategory.id] = {
                                name: food.foodCategory.name,
                                foods: []
                            };
                        }
        
                        restaurants[food.restaurant.id].categories[food.foodCategory.id].foods.push(food);
                    });
        
                    // Render grouped foods
                    for (const restaurantId in restaurants) {
                        const restaurantSection = document.createElement('div');
                        restaurantSection.classList.add('restaurant-section');
                        restaurantSection.innerHTML = `<h2>${restaurants[restaurantId].name}</h2>`;
        
                        const categories = restaurants[restaurantId].categories;
                        for (const categoryId in categories) {
                            const categorySection = document.createElement('div');
                            categorySection.classList.add('category-section');
                            categorySection.innerHTML = `<h3>${categories[categoryId].name}</h3>`;
        
                            categories[categoryId].foods.forEach(food => {
                                const foodItem = document.createElement('div');
                                foodItem.classList.add('food-item');
                                foodItem.innerHTML = `
                                    <div>
                                        <h4>${food.name}</h4>
                                        <p>${food.description}</p>
                                        <p>Price: $${food.price}</p>
                                        <p>Available: ${food.available ? 'Yes' : 'No'}</p>
                                        <p>Vegetarian: ${food.vegetarian ? 'Yes' : 'No'}</p>
                                        <p>Seasonal: ${food.seasonal ? 'Yes' : 'No'}</p>
                                    </div>
                                    <div class="food-actions">
                                        <button class="btn" onclick="editFood(${food.id})">Edit</button>
                                        <button class="btn btn-delete" onclick="deleteFood(${food.id})">Delete</button>
                                    </div>
                                `;
                                categorySection.appendChild(foodItem);
                            });
        
                            restaurantSection.appendChild(categorySection);
                        }
        
                        foodList.appendChild(restaurantSection);
                    }
                } else {
                    foodList.innerHTML = '<p>No food items found.</p>';
                }
            } catch (error) {
                console.error('Error loading foods:', error);
                showErrorMessage('Error loading foods');
            }
        }
        
        // Fetch and display all restaurants
        async function loadRestaurants() {
            try {
                const response = await fetch('http://localhost:5786/api/restaurants', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
        
                const data = await response.json();
                console.log(data); // Check what data is being returned
        
                restaurantSelect.innerHTML = '<option value="">Select Restaurant</option>';
                data.forEach(restaurant => {
                    const option = document.createElement('option');
                    option.value = restaurant.id;
                    option.textContent = restaurant.name;
                    restaurantSelect.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading restaurants:', error);
                showErrorMessage('Error loading restaurants');
            }
        }
        
        // Fetch and display categories based on selected restaurant
        async function loadCategories(restaurantId) {
            try {
                const response = await fetch(`http://localhost:5786/api/categories/restaurant/${restaurantId}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
        
                const data = await response.json();
                console.log(data); // Check what data is being returned
        
                categorySelect.innerHTML = '<option value="">Select Category</option>';
                data.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category.id;
                    option.textContent = category.name;
                    categorySelect.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading categories:', error);
                showErrorMessage('Error loading categories');
            }
        }
        
        // Add or update food item
        async function saveFood() {
            // Validation check for empty fields
            if (!restaurantSelect.value || !categorySelect.value || !foodName.value || !foodPrice.value || !foodDescription.value || !foodImages.value || !createdDate.value) {
                showErrorMessage('Please fill in all the required fields.');
                return;
            }
        
            const food = {
                restaurantId: parseInt(restaurantSelect.value, 10),
                foodCategoryId: parseInt(categorySelect.value, 10),
                name: foodName.value,
                description: foodDescription.value,
                price: parseFloat(foodPrice.value),
                images: foodImages.value.split(',').map(url => url.trim()),
                available: foodAvailable.checked,
                is_vegetarian: isVegetarian.checked,
                is_seasonal: isSeasonal.checked,
                createdDate: createdDate.value,
            };
        
            const url = isUpdate ? `http://localhost:5786/api/admin/food/${currentFoodId}` : 'http://localhost:5786/api/admin/food';
            const method = isUpdate ? 'PUT' : 'POST';
        
            try {
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(food)
                });
        
                const responseData = await response.json();
                console.log('Response Data:', responseData); // Debugging: Check the response data
        
                if (response.ok) {
                    showSuccessMessage(isUpdate ? 'Food updated successfully' : 'Food added successfully');
                    loadFoods();
                    closeModal();
                } else {
                    console.error('Error Response:', responseData); // Debugging: Log the error response
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
            } catch (error) {
                console.error('Error saving food:', error);
                showErrorMessage('Error saving food');
            }
        }
        
        // Delete food item
        async function deleteFood(foodId) {
            if (!confirm('Are you sure you want to delete this food item?')) {
                return;
            }
        
            try {
                const response = await fetch(`http://localhost:5786/api/admin/food/${foodId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
        
                if (response.ok) {
                    showSuccessMessage('Food deleted successfully');
                    loadFoods();
                } else {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
            } catch (error) {
                console.error('Error deleting food:', error);
                showErrorMessage('Error deleting food');
            }
        }
        
        // Show success message
        function showSuccessMessage(message) {
            messageDiv.innerHTML = `<div class="success-message">${message}</div>`;
            setTimeout(() => messageDiv.innerHTML = '', 3000);
        }
        
        // Show error message
        function showErrorMessage(message) {
            messageDiv.innerHTML = `<div class="error-message">${message}</div>`;
            setTimeout(() => messageDiv.innerHTML = '', 3000);
        }
        
        // Open modal for adding/updating food
        function openModal() {
            foodModal.style.display = 'flex';
        }
        
        // Close modal
        function closeModal() {
            foodModal.style.display = 'none';
            resetForm();
        }
        
        // Reset form fields
        function resetForm() {
            foodName.value = '';
            foodDescription.value = '';
            foodPrice.value = '';
            foodImages.value = '';
            foodAvailable.checked = false;
            isVegetarian.checked = false;
            isSeasonal.checked = false;
            createdDate.value = '';
            categorySelect.innerHTML = '<option value="">Select Category</option>';
            restaurantSelect.value = '';
            isUpdate = false;
            currentFoodId = null;
            modalTitle.textContent = 'Add Food';
        }
        
        // Edit food item
        function editFood(foodId) {
            openModal();
            modalTitle.textContent = 'Update Food';
            isUpdate = true;
            currentFoodId = foodId;
        
            // Fetch food details and populate form
            fetch(`http://localhost:5786/api/food/${foodId}`, {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            })
                .then(response => response.json())
                .then(food => {
                    restaurantSelect.value = food.restaurant.id;
                    loadCategories(food.restaurant.id);
                    categorySelect.value = food.foodCategory.id;
                    foodName.value = food.name;
                    foodDescription.value = food.description;
                    foodPrice.value = food.price;
                    foodImages.value = food.images.join(', ');
                    foodAvailable.checked = food.available;
                    isVegetarian.checked = food.is_vegetarian;
                    isSeasonal.checked = food.is_seasonal;
                    createdDate.value = food.createdDate;
                })
                .catch(error => {
                    console.error('Error loading food details:', error);
                    showErrorMessage('Error loading food details');
                });
        }
        
        // Load restaurants when the page loads
        document.addEventListener('DOMContentLoaded', () => {
            loadFoods();
            loadRestaurants();
        
            // Load categories based on selected restaurant
            restaurantSelect.addEventListener('change', () => {
                const restaurantId = restaurantSelect.value;
                if (restaurantId) {
                    loadCategories(restaurantId);
                } else {
                    categorySelect.innerHTML = '<option value="">Select Category</option>';
                }
            });
        
            // Handle form submission
            saveFoodBtn.addEventListener('click', saveFood);
            addFoodBtn.addEventListener('click', openModal);
        });
        </script>
        
</body>
</html>
